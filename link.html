<html>
  <head>
    <title>You're invited to Lemmy</title>
    <link rel="stylesheet" href="https://unpkg.com/mvp.css" />
    <link rel="stylesheet" href="./index.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body>
    <header>
      <h2>You're invited to</h2>
      <h1 id="roomName">Please enable javascript</h1>
    </header>
    <hr />
    <main>
      <header>
        <h2>You're going via</h2>
        <h1 id="instanceName"></h1>
        <details>
          <summary>Change instance</summary>
          <form class="box" id="instance-edit-form">
            <input
              required
              type="text"
              name="instance"
              placeholder="lemmy.ml"
            />
            <input type="submit" value="Save" />
          </form>
        </details>
      </header>
      <hr />
      <section>
        <header>
          <!-- empty header to get the padding right -->
        </header>
        <aside>
          <a href="" id="browser-link">
            <h2>Open in browser</h2>
            <img src="./chrome.svg" class="icon half" />
            <img src="./firefox.svg" class="icon half" />
            <img src="./edge.svg" class="icon half" />
            <img src="./safari-ios.svg" class="icon half" />
          </a>
        </aside>
        <aside>
          <a href="" id="liftoff-link">
            <h2>Open in Liftoff</h2>
            <img src="./liftoff.svg" class="icon" />
          </a>
        </aside>
        <aside>
          <a href="" id="memmy-link">
            <h2>Open in Memmy</h2>
            <img src="./memmy.png" class="icon" style="border-radius: 1em" />
          </a>
        </aside>
      </section>
    </main>
    <footer>
      <hr />
      <p>
        <small>
          <a href="https://github.com/lemmy-guide/site">GitHub</a>
        </small>
      </p>
    </footer>
  </body>
  <script type="application/javascript">
    // get target from search params
    const urlParams = new URLSearchParams(window.location.search);
    const target = urlParams.get("target");

    // if target is empty, redirect to home page
    if (!target) {
      window.location.replace("/");
    }

    // set room name
    document.getElementById("roomName").innerText = target;

    // prefix is baesd on the first character of target
    const prefix = target.charAt(0) === "@" ? "u" : "c";

    // instance is the hostname after the last @ symbol
    const instance =
      localStorage.getItem("instance") || target.split("@").pop();
    const instanceInput = document.querySelector('input[name="instance"]');

    // entity is the target exlcuding ! or @
    const entity = target.slice(1);

    const targetUrl = `${instance}/${prefix}/${entity}`;

    // set instance name
    document.getElementById("instanceName").innerText = instance;

    // set browser link
    document.getElementById("browser-link").href = `https://` + targetUrl;
    // set liftoff link
    document.getElementById("liftoff-link").href = `liftoff://` + targetUrl;
    // set memmy link
    document.getElementById("memmy-link").href = `memmyapp://` + targetUrl;

    document
      .getElementById("instance-edit-form")
      .addEventListener("submit", (e) => {
        e.preventDefault();
        e.stopPropagation();

        localStorage.setItem("instance", instanceInput.value);

        window.location.reload();
      });
  </script>
</html>
